name: Decision Gate (B-min penetration)

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  inputs:
    scenario:
      type: choice
      description: "gate scenario"
      required: true
      default: pass
      options:
        - pass
        - delay
        - block
        - crypto_delay
        - crypto_block

permissions:
  contents: read

jobs:
  gate:
    runs-on: ubuntu-latest
    env:
      SCENARIO: ${{ github.event.inputs.scenario || 'pass' }}

    steps:
      - name: Checkout decision-os-paper
        uses: actions/checkout@v4

      - name: Checkout mmar-l0-core
        uses: actions/checkout@v4
        with:
          repository: shin4141/mmar-l0-core
          ref: main
          path: mmar-l0-core

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate temp inputs (asof_pack.json / delta_entry.json)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, os

          scenario = os.environ.get("SCENARIO", "pass").strip()

          asof = {
            "asof_timestamp_jst": "2026-01-22",
            "seat": { "decision_owner": "Shin", "auditor": "CI" },
            "objective": "Decision Gate demo",
            "constraints": ["evidence-first", "as-of fixed"],
            "ssot": { "repo": "decision-os-paper", "ref": "github.sha" }
          }

          if scenario == "block":
            # AUTO-BLOCK: high x high + no evidence
            delta = {
              "delta_id": "demo-auto-block",
              "summary": "auto block (high x high, no evidence)",
              "request": "abstract placeholder",
              "impact": { "externality": "high", "irreversibility": "high" },
              "evidence": []
            }

          elif scenario == "delay":
            # AUTO-DELAY: no evidence, but not high x high
            delta = {
              "delta_id": "demo-auto-delay",
              "summary": "auto delay (no evidence)",
              "request": "needs recheck",
              "impact": { "externality": "low", "irreversibility": "low" },
              "evidence": []
            }

          else:
            # PASS: evidence exists
            delta = {
              "delta_id": "demo-pass",
              "summary": "pass (has evidence)",
              "request": "update README",
              "impact": { "externality": "low", "irreversibility": "low" },
              "evidence": ["ex:doc"]
            }

          with open("asof_pack.json", "w", encoding="utf-8") as f:
            json.dump(asof, f, ensure_ascii=False, indent=2)
          with open("delta_entry.json", "w", encoding="utf-8") as f:
            json.dump(delta, f, ensure_ascii=False, indent=2)

          print("SCENARIO=", scenario)
          PY

      - name: Run gate (mmar-l0-core)
        shell: bash
        run: |
          set -euo pipefail
          export PYTHONPATH="${GITHUB_WORKSPACE}/mmar-l0-core:${PYTHONPATH:-}"
          python -m core.run_once --asof asof_pack.json --delta delta_entry.json --out decision_gate.json
          echo "--- decision_gate.json ---"
          cat decision_gate.json

      - name: Enforce CI by severity (BLOCK => exit 1)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, sys
          with open("decision_gate.json","r",encoding="utf-8") as f:
            data = json.load(f)
          sev = (data.get("severity") or "").upper().strip() or "BLOCK"
          print("[gate] severity =", sev)
          sys.exit(1 if sev == "BLOCK" else 0)
          PY

      - name: Upload gate artifact (decision_gate.json)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: decision_gate
          path: decision_gate.json


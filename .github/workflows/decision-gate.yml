name: Decision Gate (B-min penetration)

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      scenario:
        description: "gate scenario (pass | block)"
        required: true
        default: "pass"

permissions:
  contents: read

jobs:
  gate:
    runs-on: ubuntu-latest
    env:
      SCENARIO: ${{ github.event.inputs.scenario || 'pass' }}

    steps:
      - name: Checkout decision-os-paper
        uses: actions/checkout@v4

      - name: Checkout mmar-l0-core
        uses: actions/checkout@v4
        with:
          repository: shin4141/mmar-l0-core
          ref: main
          path: mmar-l0-core

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate temp inputs (asof_pack.json / delta_entry.json)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, os

          scenario = os.environ.get("SCENARIO", "pass").strip()

          asof = {
            "asof_timestamp_jst": "2026-01-22",
            "seat": { "decision_owner": "Shin", "auditor": "CI" },
            "objective": "Demonstrate gate generation and CI enforcement",
            "constraints": ["B-min penetration", "no irreversible harm", "evidence-first"],
            "anchors": ["generated inside workflow", "no external secrets"],
            "evaluation_function": ["severity=PASS|DELAY|BLOCK", "until=max", "evidence=UNION"],
            "unknown_set": ["real-world unknowns are excluded (demo only)"],
            "finite_closure": ["BLOCK => stop"],
            "ssot": { "repo": "decision-os-paper", "ref": "github.sha" }
          }

          if scenario == "block":
            delta = {
              "delta_id": "demo-block",
              "summary": "Irreversible + high externality action (demo) => expected BLOCK",
              "impact": { "externality": "high", "irreversibility": "high", "power": "high" },
              "request": "Abstract misuse-risk placeholder (no actionable details).",
              "notes": ["Control demo only."]
            }
          else:
            delta = {
              "delta_id": "demo-pass",
              "summary": "Low-impact reversible change (demo) => expected PASS/DELAY (not BLOCK)",
              "impact": { "externality": "low", "irreversibility": "low", "power": "low" },
              "request": "Update README wording / add a safe diagram link",
              "notes": ["Control demo only."]
            }

          with open("asof_pack.json", "w", encoding="utf-8") as f:
            json.dump(asof, f, ensure_ascii=False, indent=2)
          with open("delta_entry.json", "w", encoding="utf-8") as f:
            json.dump(delta, f, ensure_ascii=False, indent=2)

          print("SCENARIO=", scenario)
          PY

      - name: Run gate (mmar-l0-core)
        shell: bash
        run: |
          set -euo pipefail
          export PYTHONPATH="${GITHUB_WORKSPACE}/mmar-l0-core:${PYTHONPATH:-}"
          python -m core.run_once --asof asof_pack.json --delta delta_entry.json --out decision_gate.json
          echo "--- decision_gate.json ---"
          cat decision_gate.json

      - name: Enforce CI by severity (BLOCK => exit 1)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, sys
          with open("decision_gate.json","r",encoding="utf-8") as f:
            data = json.load(f)
          sev = (data.get("severity") or data.get("Severity") or "").upper().strip() or "BLOCK"
          print("[gate] severity =", sev)
          sys.exit(1 if sev == "BLOCK" else 0)
          PY

      - name: Upload gate artifact (decision_gate.json)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: decision_gate
          path: decision_gate.json

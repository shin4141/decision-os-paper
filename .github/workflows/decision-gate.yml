name: Decision Gate (B-min penetration)

on:
  push:
    branches: ["main"]

  workflow_dispatch:
    inputs:
      scenario:
        type: choice
        description: "gate scenario"
        required: true
        default: pass
        options:
          - pass
          - delay
          - block
          - crypto_delay
          - crypto_block
          - coord_delay
          - coord_block
          - phish_delay
          - allowlist_block
          - secrets_block

permissions:
  contents: read

jobs:
  gate:
    runs-on: ubuntu-latest
    env:
      SCENARIO: ${{ github.event.inputs.scenario || 'pass' }}

    steps:
      - name: Checkout decision-os-paper
        uses: actions/checkout@v4

      - name: Checkout mmar-l0-core
        uses: actions/checkout@v4
        with:
          repository: shin4141/mmar-l0-core
          ref: main
          path: mmar-l0-core

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate temp inputs (asof_pack.json / delta_entry.json)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, os

          scenario = os.environ.get("SCENARIO", "pass").strip()

          asof = {
            "asof_timestamp_jst": "2026-01-22",
            "seat": { "decision_owner": "Shin", "auditor": "CI" },
            "objective": "Decision Gate demo",
            "constraints": ["evidence-first", "as-of fixed"],
            "ssot": { "repo": "decision-os-paper", "ref": "github.sha" }
          }

          if scenario in ("block", "crypto_block"):
            delta = {
              "delta_id": "demo-auto-block",
              "summary": f"{scenario} (high x high, no evidence)",
              "request": "abstract placeholder",
              "impact": { "externality": "high", "irreversibility": "high" },
              "evidence": []
            }
            if scenario == "crypto_block":
              delta["request"] = "wallet approval (Approve/Permit) requested"
              delta["crypto"] = {
                "action": "APPROVE",
                "chain": "Ethereum",
                "asset": "USDC",
                "spender_or_to": "0x0000000000000000000000000000000000000000",
                "amount": "unlimited"
              }

          elif scenario in ("delay", "crypto_delay"):
            delta = {
              "delta_id": "demo-auto-delay",
              "summary": f"{scenario} (no evidence)",
              "request": "needs recheck",
              "impact": { "externality": "low", "irreversibility": "low" },
              "evidence": []
            }
            if scenario == "crypto_delay":
              delta["request"] = "wallet signing requested (needs evidence before proceeding)"
              delta["crypto"] = {
                "action": "SIGN",
                "chain": "Ethereum",
                "asset": "N/A",
                "spender_or_to": "N/A",
                "amount": "N/A"
              }

          elif scenario == "coord_delay":
            delta = {
              "delta_id": "demo-coord-delay",
              "summary": "coord_delay (distribution suspicious-ish)",
              "request": "consider skipping if coordination is high",
              "impact": { "externality": "medium", "irreversibility": "medium" },
              "evidence": [],
              "distribution": {
                "holders": 120,
                "top10_pct": 45,
                "snipers_pct": 25,
                "bundlers_pct": 15,
                "snipers_none_sold": True
              }
            }

          elif scenario == "coord_block":
            delta = {
              "delta_id": "demo-coord-block",
              "summary": "coord_block (distribution very suspicious)",
              "request": "skip: coordinated control suspected",
              "impact": { "externality": "high", "irreversibility": "high" },
              "evidence": [],
              "distribution": {
                "holders": 60,
                "top10_pct": 70,
                "snipers_pct": 35,
                "bundlers_pct": 30,
                "snipers_none_sold": True
              }
            }

          elif scenario == "phish_delay":
            delta = {
              "delta_id": "demo-phish-delay",
              "summary": "phish_delay (domain mismatch suspect)",
              "request": "a link looks suspicious; require evidence before signing",
              "impact": { "externality": "high", "irreversibility": "high" },
              "evidence": [],
              "web": {
                "url": "https://uniswap-airdrop.example.com",
                "claimed_brand": "Uniswap",
                "official_domains": ["uniswap.org"],
                "referrer": "X/Twitter"
              }
            }

          elif scenario == "allowlist_block":
            delta = {
              "delta_id": "demo-allowlist-block",
              "summary": "allowlist_block (unknown recipient)",
              "request": "transfer to a new address not in allowlist",
              "impact": { "externality": "high", "irreversibility": "high" },
              "evidence": [],
              "transfer": {
                "chain": "Ethereum",
                "asset": "USDC",
                "to": "0x1111111111111111111111111111111111111111",
                "amount": "5000"
              },
              "allowlist": {
                "mode": "ALLOWLIST_ONLY",
                "addresses": ["0x2222222222222222222222222222222222222222"]
              }
            }

          elif scenario == "secrets_block":
            delta = {
              "delta_id": "demo-secrets-block",
              "summary": "secrets_block (token/key leak suspect)",
              "request": "a secret-like string is about to be published",
              "impact": { "externality": "high", "irreversibility": "high" },
              "evidence": [],
              "secrets": {
                "channel": "github_issue",
                "pattern": "looks_like_api_key",
                "sample": "sk-live-xxxxxxxxxxxxxxxx"
              }
            }

          else:
            delta = {
              "delta_id": "demo-pass",
              "summary": "pass (has evidence)",
              "request": "update README",
              "impact": { "externality": "low", "irreversibility": "low" },
              "evidence": ["ex:doc"]
            }

          with open("asof_pack.json", "w", encoding="utf-8") as f:
            json.dump(asof, f, ensure_ascii=False, indent=2)
          with open("delta_entry.json", "w", encoding="utf-8") as f:
            json.dump(delta, f, ensure_ascii=False, indent=2)

          print("SCENARIO=", scenario)
          PY

      - name: Run gate (mmar-l0-core)
        shell: bash
        run: |
          set -euo pipefail
          export PYTHONPATH="${GITHUB_WORKSPACE}/mmar-l0-core:${PYTHONPATH:-}"
          python -m core.run_once --asof asof_pack.json --delta delta_entry.json --out decision_gate.json

      - name: Annotate decision_gate.json (policy packs)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, urllib.parse

          def load_json(path, default=None):
            try:
              with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
            except FileNotFoundError:
              return default if default is not None else {}

          delta = load_json("delta_entry.json", {})
          gate  = load_json("decision_gate.json", {})
          th    = load_json("thresholds.json", {"coordination":{"delay_score":3,"block_score":5,"top10_pct_delay":40,"top10_pct_block":60}})
          th_c  = th.get("coordination") or {}

          sev = (gate.get("severity") or "").upper().strip() or "PASS"
          reasons = list(gate.get("reason_codes") or [])

          evidence = delta.get("evidence") or []
          impact = delta.get("impact") or {}
          ext = (impact.get("externality") or "").lower()
          irr = (impact.get("irreversibility") or "").lower()

          def override(new_sev, suggested_fix=None, recheck=None, until=None):
            nonlocal sev
            # precedence: BLOCK > DELAY > PASS
            rank = {"PASS":0,"DELAY":1,"BLOCK":2}
            if rank.get(new_sev,0) > rank.get(sev,0):
              sev = new_sev
              if suggested_fix is not None: gate["suggested_fix"] = suggested_fix
              if recheck is not None: gate["recheck"] = recheck
              if until is not None: gate["until"] = until
              gate["next_action"] = None if new_sev == "BLOCK" else "RERUN_AFTER_UNTIL"

          # --- Crypto pack ---
          crypto = delta.get("crypto") or {}
          action = (crypto.get("action") or "").upper().strip()
          amount = (crypto.get("amount") or "").lower().strip()

          if crypto:
            reasons.append("CRYPTO_CONTEXT")
            if action == "APPROVE" and amount in ("unlimited","infinite","max","uint256max"):
              reasons.append("APPROVAL_UNLIMITED_ALLOWANCE")

          # --- Coordination / distribution pack ---
          dist = delta.get("distribution") or {}
          if dist:
            reasons.append("DISTRIBUTION_CONTEXT")
            holders = int(dist.get("holders") or 0)
            top10   = float(dist.get("top10_pct") or 0)
            snipers = float(dist.get("snipers_pct") or 0)
            bundlers= float(dist.get("bundlers_pct") or 0)
            none_sold = bool(dist.get("snipers_none_sold") or False)

            score = 0
            if top10 >= th_c.get("top10_pct_delay", 40): score += 1
            if (snipers + bundlers) >= 40: score += 1
            if none_sold: score += 1
            if holders and holders <= 80: score += 1
            if top10 >= th_c.get("top10_pct_block", 60): score += 1

            reasons.append(f"COORDINATION_SCORE_{score}")

            if score >= th_c.get("block_score", 5):
              reasons.append("COORDINATION_EXTREME_SKIP")
              override("BLOCK", suggested_fix=["Skip this token (coordination suspected)."])
            elif score >= th_c.get("delay_score", 3):
              reasons.append("COORDINATION_HIGH_RECHECK")
              override("DELAY",
                       suggested_fix=["Attach distribution evidence and re-run. If still coordinated, skip."],
                       recheck=["Verify distribution/snipers via independent source", "Re-run after evidence attached"],
                       until="AUTO_SHORT_RECHECK")

          # --- Phishing / domain pack ---
          web = delta.get("web") or {}
          if web:
            reasons.append("WEB_CONTEXT")
            url = (web.get("url") or "").strip()
            claimed = (web.get("claimed_brand") or "").strip()
            official = set([d.lower().strip() for d in (web.get("official_domains") or []) if d])

            host = ""
            try:
              host = (urllib.parse.urlparse(url).hostname or "").lower()
            except Exception:
              host = ""

            if official and host and all(not host.endswith(d) for d in official):
              reasons.append("DOMAIN_MISMATCH_SUSPECT")
              override("DELAY",
                       suggested_fix=["Use official domain only; attach evidence (official link) and re-run."],
                       recheck=["Verify the official domain from trusted source", "Re-run after evidence attached"],
                       until="AUTO_SHORT_RECHECK")

          # --- Allowlist / recipient pack ---
          allow = delta.get("allowlist") or {}
          tx = delta.get("transfer") or {}
          if allow and tx:
            reasons.append("ALLOWLIST_CONTEXT")
            mode = (allow.get("mode") or "").upper().strip()
            to = (tx.get("to") or "").lower().strip()
            addresses = set([a.lower().strip() for a in (allow.get("addresses") or []) if a])

            if mode == "ALLOWLIST_ONLY" and to and to not in addresses:
              reasons.append("UNKNOWN_RECIPIENT_NOT_IN_ALLOWLIST")
              override("BLOCK", suggested_fix=["Recipient not in allowlist. Add to allowlist only after verification."])

          # --- Secrets pack ---
          sec = delta.get("secrets") or {}
          if sec:
            reasons.append("SECRETS_CONTEXT")
            reasons.append("POTENTIAL_SECRET_LEAK")
            override("BLOCK", suggested_fix=["Do not publish secrets. Rotate keys/tokens immediately and re-run after cleanup."])

          gate["severity"] = sev

          # de-dup preserving order
          seen, out = set(), []
          for r in reasons:
            if r and r not in seen:
              seen.add(r)
              out.append(r)

          gate["reason_codes"] = out

          with open("decision_gate.json","w",encoding="utf-8") as f:
            json.dump(gate, f, ensure_ascii=False, indent=2)

          print("[gate] annotated reason_codes =", out)
          print("[gate] final severity =", sev)
          PY

      - name: Show decision_gate.json
        shell: bash
        run: |
          set -euo pipefail
          echo "--- decision_gate.json ---"
          cat decision_gate.json

      - name: Enforce CI by severity (BLOCK => exit 1)
        shell: bash
        run: |
          set -euo pipefail

          SEV="$(python - <<'PY'
          import json
          with open("decision_gate.json","r",encoding="utf-8") as f:
            data = json.load(f)
          sev = (data.get("severity") or "").upper().strip() or "BLOCK"
          print(sev)
          PY
          )"

          echo "[gate] severity = ${SEV}"

          # Only fail CI on push. Manual runs (workflow_dispatch) should still upload artifacts.
          if [ "${{ github.event_name }}" = "push" ] && [ "${SEV}" = "BLOCK" ]; then
            exit 1
          else
            echo "[gate] not failing this run (event=${{ github.event_name }}, severity=${SEV})"
          fi

      - name: Upload gate artifact (decision_gate.json)
        uses: actions/upload-artifact@v4
        with:
          name: decision_gate
          path: decision_gate.json
